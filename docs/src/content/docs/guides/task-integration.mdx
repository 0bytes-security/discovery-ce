---
title: "Integrating Security Tools: A Schema-Driven Approach"
editUrl: https://github.com/0bytes-security/discovery-ce/edit/docs/src/content/docs/guides/task-integration.mdx
---

**Discovery's** flexibility comes from its ability to integrate a wide range of security assessment tools seamlessly. This document guides you through the process of adding a new tool using a schema-driven approach.

## Understanding the Task Schema

The [`task.schema.json`](https://github.com/0bytes-security/discovery-ce/blob/main/task.schema.json) file defines the structure for all task definitions. Each task is described in a separate YAML file that adheres to this schema.

### Key Schema Fields:

- **`id`:** A unique, machine-readable identifier for the task. Use reverse domain name notation (e.g., `com.example.tools.nmap`).
- **`name`:** A user-friendly name for the task (e.g., "Nmap Port Scan").
- **`description`:** A detailed explanation of what the task accomplishes.
- **`image`:** The Docker image to use when executing the task. Specify the full image name and tag (e.g., `instrumentisto/nmap:latest`).
- **`parameters`:** A dictionary of input parameters for the task. Each parameter should include:
  - `description`: A description of the parameter.
  - `schema`: A JSON schema defining the parameter's type and validation rules.
  - `default`: (Optional) A default value for the parameter.
  - `is-file`: (Optional) Set to `true` if the parameter is a file input.
  - `file-type`: (Optional) The type of file if `is-file` is true (e.g., `txt`, `json`, `xml`).
- **`command`:** The command template to execute within the Docker container. Use placeholders for parameters and output files (e.g., `nmap -p ${{ parameters.ports }} ${{ parameters.ports }} -oX ${{ outputs.scan_results }}`).
- **`outputs`:** A dictionary of outputs generated by the task. Each output should include:
  - `description`: A description of the output.
  - `schema`: A JSON schema for validating the output data.
  - `is-file`: (Optional) Set to `true` if the output is a file.
  - `file-type`: (Optional) The file type for file outputs.

### Important Notes:

1. Ensure the `id` is unique across all tasks.
2. The `image` must be included in the `DOCKER_ALLOWED_IMAGES` environment variable in the backend.
3. Use `$RUN_DIR` to access the task's input and output files. For instance, in the task's Docker container, you might use `mkdir -p $RUN_DIR/inputs` and `mkdir -p $RUN_DIR/outputs`.
4. Only the following `file-type` values are supported: `json`, `jsonl`, `csv`, `txt`.

## Task Definition Examples

### Nmap Task Example

Let's create a task definition for Nmap:

**File: `nmap.task.discovery.yaml`**

```yaml
version: "1.0"
id: discovery.tasks.network.nmap
name: Nmap Port Scan
description: Performs a port scan on target hosts using Nmap.
image: instrumentisto/nmap:latest
parameters:
  targets:
    description: A list of target IP addresses or hostnames.
    schema:
      type: array
      items:
        type: string
  ports:
    description: The port range or list of ports to scan (e.g., "1-1000", "80,443").
    schema:
      type: string
    default: "1-1000"
command: > # Multi-line command
  nmap
  -p $ports
  $targets
  -oX $scan_results
outputs:
  scan_results:
    description: The Nmap scan results in XML format.
    schema:
      type: object
    is-file: true
    file-type: txt
```
**Explanation:**

- The `command` uses placeholders (`$`) to dynamically insert parameter values (`ports`, `targets`) and the path to the output file (`scan_results.path`).
- The `TaskRunner` class will handle replacing these placeholders during task execution. 


### Subfinder Task Example

Here's another example for Subfinder:

**File: `subfinder.task.discovery.yaml`**

```yaml
version: "1.0"
id: discovery.tasks.recon.subfinder # Unique task ID
name: Subfinder Subdomain Enumeration
description: Enumerates subdomains of a target domain using Subfinder.
image: projectdiscovery/subfinder:latest
parameters:
  domain:
    description: The target domain name.
    schema:
      type: string
      format: hostname # Ensures the domain format is valid
command: > # Multi-line command
  subfinder
  -d $domain
  -o $subdomains
outputs:
  subdomains:
    description: A list of discovered subdomains.
    schema:
      type: array
      items:
        type: string
    is-file: true
    file-type: txt
```




## Task Management API Endpoints

Discovery provides API endpoints for managing tasks. These endpoints allow you to register new tasks, retrieve task details, and execute tasks.

### Registering Tasks (`POST /tasks`)

- **Endpoint:** `/tasks` (POST)
- **Description:** Registers a new task by uploading its schema. The schema can be in JSON or YAML format.
- **Request Body:**
    - `schema`: The task schema file to upload.
- **Example:**

```bash
curl -X POST \
  -H "Content-Type: multipart/form-data" \
  -F "schema=@nmap.task.discovery.yaml" \
  http://localhost:8000/tasks
```

- **Response:**
    - **201 Created:** The task was successfully registered. The response will include the ID of the new task. 
    - **400 Bad Request:** The request was invalid (e.g., invalid file type, invalid schema, duplicate task ID).

### Retrieving Task Details (`GET /tasks/{task_id}`)

- **Endpoint:** `/tasks/{task_id}` (GET)
- **Description:**  Retrieves the schema for a registered task. 
- **Path Parameters:**
    - `task_id`: The ID of the task.
- **Example:**

```bash
curl http://localhost:8000/tasks/discovery.tasks.network.nmap
```

- **Response:**
    - **200 OK:** Returns the task schema in JSON format. 
    - **404 Not Found:** The task with the specified ID was not found. 

### Executing Tasks (`POST /tasks/run`)

- **Endpoint:** `/tasks/run` (POST)
- **Description:**  Executes a registered task with the provided parameters.
- **Request Body:**
    - `id`: The ID of the task to execute.
    - `parameters`: A dictionary of input parameters for the task. 
    - `owner_id`: The user ID initiating the task.
    - `parent_id`: (Optional) The ID of the parent task if this task is part of a workflow. 
- **Example:**

```bash
curl -X POST \
  -H "Content-Type: application/json" \
  -d '{"id": "discovery.tasks.network.nmap", "parameters": {"targets": ["192.168.1.1"], "ports": "1-1000"}, "owner_id": "user123"}' \
  http://localhost:8000/tasks/run
``` 